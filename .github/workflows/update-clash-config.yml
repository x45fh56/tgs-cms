name: Update Clash Config for Mohimo

on:
  workflow_dispatch:
  schedule:
    - cron: '30 11 * * *'  # 15:00 ØªÙ‡Ø±Ø§Ù†

jobs:
  convert-to-clash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq

    - name: Download VLESS Servers
      run: |
        echo "ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø³Ø±ÙˆØ±Ù‡Ø§ Ø§Ø² Ù„ÛŒÙ†Ú©..."
        curl -L -o vless-input.txt \
          "https://raw.githubusercontent.com/x45fh56/tgs/refs/heads/main/Servers/Protocols/vless.txt"
        
        echo "ğŸ“Š Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù‡:"
        head -20 vless-input.txt
        
        echo ""
        echo "ğŸ“ˆ ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ·: $(wc -l < vless-input.txt)"

    - name: Start Subconverter
      run: |
        docker run -d --name subconverter \
          -p 25500:25500 \
          tindy2013/subconverter:latest
        
        echo "â³ ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Subconverter..."
        sleep 15
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø³Ø±ÙˆÛŒØ³ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª
        for i in {1..10}; do
          if curl -s http://localhost:25500/version > /dev/null 2>&1; then
            echo "âœ… Subconverter Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!"
            break
          fi
          echo "Ù…Ù†ØªØ¸Ø±... ØªÙ„Ø§Ø´ $i Ø§Ø² 10"
          sleep 3
        done

    - name: Convert to Clash Format
      run: |
        echo "ğŸ”„ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÙØ±Ù…Øª Clash..."
        
        # URL encode Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©
        SOURCE_URL="https://raw.githubusercontent.com/x45fh56/tgs/refs/heads/main/Servers/Protocols/vless.txt"
        
        # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        curl -v -o clash-mohimo.yaml \
          "http://localhost:25500/sub?target=clash&new_name=true&url=${SOURCE_URL}&emoji=true&list=false&udp=true&tfo=false&expand=true&scv=false&fdn=false"
        
        echo ""
        echo "ğŸ“„ Ù†ØªÛŒØ¬Ù‡ ØªØ¨Ø¯ÛŒÙ„:"
        cat clash-mohimo.yaml

    - name: Verify Output
      run: |
        echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ..."
        
        if [ -f clash-mohimo.yaml ]; then
          FILE_SIZE=$(wc -c < clash-mohimo.yaml)
          echo "âœ… ÙØ§ÛŒÙ„ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ - Ø­Ø¬Ù…: $FILE_SIZE bytes"
          
          if [ "$FILE_SIZE" -lt 100 ]; then
            echo "âš ï¸ ÙØ§ÛŒÙ„ Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú©Ù‡! Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø®Ø·Ø§ Ø¯Ø§Ø±Ù‡"
            cat clash-mohimo.yaml
          else
            echo "âœ… ÙØ§ÛŒÙ„ Ø¨Ù‡ Ù†Ø¸Ø± ØµØ­ÛŒØ­ Ø§Ø³Øª"
            echo ""
            echo "ğŸ“‹ 60 Ø®Ø· Ø§ÙˆÙ„:"
            head -60 clash-mohimo.yaml
          fi
        else
          echo "âŒ ÙØ§ÛŒÙ„ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯!"
          exit 1
        fi

    - name: Fallback - Direct Conversion
      if: failure()
      run: |
        echo "ğŸ”§ Ø±ÙˆØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: ØªØ¨Ø¯ÛŒÙ„ Ù…Ø³ØªÙ‚ÛŒÙ…..."
        
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API Ø¹Ù…ÙˆÙ…ÛŒ subconverter
        curl -o clash-mohimo.yaml \
          "https://api.subconverter.org/sub?target=clash&url=https://raw.githubusercontent.com/x45fh56/tgs/refs/heads/main/Servers/Protocols/vless.txt"
        
        cat clash-mohimo.yaml

    - name: Upload Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: clash-config-mohimo
        path: |
          clash-mohimo.yaml
          vless-input.txt
        retention-days: 30

    - name: Commit and Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ Clash - $(date +'%Y-%m-%d %H:%M:%S')"
        file_pattern: "clash-mohimo.yaml"
        branch: main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup
      if: always()
      run: |
        docker stop subconverter || true
        docker rm subconverter || true
