name: Update Clash Config for Mohimo

on:
  workflow_dispatch:
  schedule:
    - cron: '30 11 * * *'  # 15:00 ØªÙ‡Ø±Ø§Ù†

jobs:
  convert-to-clash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python Dependencies
      run: |
        pip install pyyaml requests --break-system-packages

    - name: Download VLESS Servers
      run: |
        echo "ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ø³Ø±ÙˆØ±Ù‡Ø§..."
        curl -L -o vless-input.txt \
          "https://raw.githubusercontent.com/x45fh56/tgs/refs/heads/main/Servers/Protocols/vless.txt"
        
        echo "âœ… Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯ - ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ·: $(wc -l < vless-input.txt)"

    - name: Create Converter Script
      run: |
        cat > convert_to_clash.py << 'EOF'
        #!/usr/bin/env python3
        import yaml
        import urllib.parse
        import re
        from typing import Dict, List

        def parse_vless_url(url: str) -> Dict:
            """ØªØ¨Ø¯ÛŒÙ„ URL VLESS Ø¨Ù‡ ÙØ±Ù…Øª Clash"""
            if not url.startswith('vless://'):
                return None
            
            try:
                # Ø­Ø°Ù vless://
                url = url.replace('vless://', '')
                
                # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ UUID Ùˆ Ø¨Ù‚ÛŒÙ‡
                uuid_part, rest = url.split('@', 1)
                
                # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ server:port Ùˆ params
                server_part, params_part = rest.split('?', 1)
                server, port = server_part.split(':', 1)
                
                # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ params Ùˆ name
                if '#' in params_part:
                    params_str, name = params_part.split('#', 1)
                    name = urllib.parse.unquote(name)
                else:
                    params_str = params_part
                    name = f"{server}:{port}"
                
                # Parse Ú©Ø±Ø¯Ù† parameters
                params = dict(urllib.parse.parse_qsl(params_str))
                
                # Ø³Ø§Ø®Øª proxy config
                proxy = {
                    'name': name,
                    'type': 'vless',
                    'server': server,
                    'port': int(port),
                    'uuid': uuid_part,
                    'udp': True,
                    'tls': params.get('security') in ['tls', 'reality'],
                    'skip-cert-verify': params.get('insecure', '0') == '1' or params.get('allowInsecure', '0') == '1',
                }
                
                # Network type
                network_type = params.get('type', 'tcp')
                proxy['network'] = network_type
                
                # TLS/Reality settings
                if params.get('security') == 'reality':
                    proxy['reality-opts'] = {
                        'public-key': params.get('pbk', ''),
                        'short-id': params.get('sid', ''),
                    }
                    if params.get('sni'):
                        proxy['servername'] = params.get('sni')
                    if params.get('fp'):
                        proxy['client-fingerprint'] = params.get('fp')
                
                elif params.get('security') == 'tls':
                    if params.get('sni'):
                        proxy['servername'] = params.get('sni')
                    if params.get('fp'):
                        proxy['client-fingerprint'] = params.get('fp')
                    if params.get('alpn'):
                        proxy['alpn'] = params.get('alpn').split(',')
                
                # WebSocket
                if network_type == 'ws':
                    proxy['ws-opts'] = {}
                    if params.get('path'):
                        proxy['ws-opts']['path'] = urllib.parse.unquote(params.get('path'))
                    if params.get('host'):
                        proxy['ws-opts']['headers'] = {'Host': params.get('host')}
                
                # gRPC
                elif network_type in ['grpc', 'gun']:
                    proxy['grpc-opts'] = {}
                    if params.get('serviceName'):
                        proxy['grpc-opts']['grpc-service-name'] = params.get('serviceName')
                
                # HTTP/2
                elif network_type in ['h2', 'http']:
                    proxy['h2-opts'] = {}
                    if params.get('path'):
                        proxy['h2-opts']['path'] = urllib.parse.unquote(params.get('path'))
                    if params.get('host'):
                        proxy['h2-opts']['host'] = [params.get('host')]
                
                # Flow (Ø¨Ø±Ø§ÛŒ Reality)
                if params.get('flow'):
                    proxy['flow'] = params.get('flow')
                
                return proxy
                
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± parse: {str(e)[:50]}")
                return None

        def main():
            print("ğŸ”„ Ø´Ø±ÙˆØ¹ ØªØ¨Ø¯ÛŒÙ„...")
            
            # Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒ
            with open('vless-input.txt', 'r') as f:
                lines = [line.strip() for line in f if line.strip() and line.startswith('vless://')]
            
            print(f"ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ VLESS: {len(lines)}")
            
            # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Clash
            proxies = []
            for i, line in enumerate(lines, 1):
                proxy = parse_vless_url(line)
                if proxy:
                    proxies.append(proxy)
                    if i <= 5:
                        print(f"âœ… {i}. {proxy['name']}")
            
            print(f"\nâœ… ØªØ¹Ø¯Ø§Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±: {len(proxies)}")
            
            # Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Clash
            clash_config = {
                'port': 7890,
                'socks-port': 7891,
                'allow-lan': True,
                'mode': 'rule',
                'log-level': 'info',
                'external-controller': '127.0.0.1:9090',
                'proxies': proxies,
                'proxy-groups': [
                    {
                        'name': 'ğŸš€ Ø§Ù†ØªØ®Ø§Ø¨',
                        'type': 'select',
                        'proxies': ['â™»ï¸ Ø®ÙˆØ¯Ú©Ø§Ø±', 'ğŸ”˜ Ø¯Ø³ØªÛŒ'] + [p['name'] for p in proxies[:20]]
                    },
                    {
                        'name': 'â™»ï¸ Ø®ÙˆØ¯Ú©Ø§Ø±',
                        'type': 'url-test',
                        'proxies': [p['name'] for p in proxies],
                        'url': 'http://www.gstatic.com/generate_204',
                        'interval': 300
                    },
                    {
                        'name': 'ğŸ”˜ Ø¯Ø³ØªÛŒ',
                        'type': 'select',
                        'proxies': [p['name'] for p in proxies]
                    }
                ],
                'rules': [
                    'DOMAIN-SUFFIX,ir,DIRECT',
                    'GEOIP,IR,DIRECT',
                    'MATCH,ğŸš€ Ø§Ù†ØªØ®Ø§Ø¨'
                ]
            }
            
            # Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„
            with open('clash-mohimo.yaml', 'w', encoding='utf-8') as f:
                yaml.dump(clash_config, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
            
            print("\nâœ… ÙØ§ÛŒÙ„ clash-mohimo.yaml Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!")
            print(f"ğŸ“¦ Ø­Ø¬Ù… ÙØ§ÛŒÙ„: {len(yaml.dump(clash_config))} bytes")

        if __name__ == '__main__':
            main()
        EOF
        
        chmod +x convert_to_clash.py

    - name: Convert to Clash
      run: |
        python3 convert_to_clash.py

    - name: Verify Output
      run: |
        echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ..."
        ls -lh clash-mohimo.yaml
        echo ""
        echo "ğŸ“‹ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø² ÙØ§ÛŒÙ„:"
        head -100 clash-mohimo.yaml

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: clash-config-mohimo
        path: |
          clash-mohimo.yaml
          vless-input.txt
        retention-days: 30

    - name: Commit and Push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ Clash - $(date +'%Y-%m-%d %H:%M:%S')"
        file_pattern: "clash-mohimo.yaml"
        branch: main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
